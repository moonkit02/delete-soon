rules:
  - id: detect-shai-hulud-backdoor
    languages:
      - yaml
    message: The Shai-hulud backdoor creates a purposefully vulnerable github action
      with the name `discussion.yaml`. 
    paths:
      include:
        - "**/.github/workflows/discussion.yaml"
    metadata:
      category: security
      cwe:
        - "CWE-509: Replicating Malicious Code (Virus or Worm)"
      owasp:
        - A01:2017 - Injection
        - A03:2021 - Injection
        - A05:2025 - Injection
      technology:
        - github-actions
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      likelihood: HIGH
      impact: HIGH
      confidence: HIGH
      license: Semgrep Rules License v1.0. For more details, visit
        semgrep.dev/legal/rules-license
      vulnerability_class:
        - Command Injection
      source_rule_url: https://www.wiz.io/blog/shai-hulud-2-0-ongoing-supply-chain-attack
      references:
        - https://www.aikido.dev/blog/shai-hulud-strikes-again-hitting-zapier-ensdomains
    patterns:
      - pattern-inside: "steps: [...]"
      - pattern-inside: |
          - run: ...
            ...
      - pattern: "run: $SHELL"
      - metavariable-pattern:
          language: generic
          metavariable: $SHELL
          patterns:
            - pattern-either:
                - pattern: ${{ github.event.issue.title }}
                - pattern: ${{ github.event.issue.body }}
                - pattern: ${{ github.event.pull_request.title }}
                - pattern: ${{ github.event.pull_request.body }}
                - pattern: ${{ github.event.comment.body }}
                - pattern: ${{ github.event.review.body }}
                - pattern: ${{ github.event.review_comment.body }}
                - pattern: ${{ github.event.pages. ... .page_name}}
                - pattern: ${{ github.event.head_commit.message }}
                - pattern: ${{ github.event.head_commit.author.email }}
                - pattern: ${{ github.event.head_commit.author.name }}
                - pattern: ${{ github.event.commits ... .author.email }}
                - pattern: ${{ github.event.commits ... .author.name }}
                - pattern: ${{ github.event.pull_request.head.ref }}
                - pattern: ${{ github.event.pull_request.head.label }}
                - pattern: ${{ github.event.pull_request.head.repo.default_branch }}
                - pattern: ${{ github.head_ref }}
                - pattern: ${{ github.event.inputs ... }}
                - pattern: ${{ github.event.discussion.title }}
                - pattern: ${{ github.event.discussion.body }}
                - pattern: ${{ inputs ... }}
    severity: ERROR

